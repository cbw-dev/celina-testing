<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filterable Link Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Optional: Customize Tailwind theme if needed
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                    },
                    colors: {
                        'brand-purple': '#5A1F65',
                        'region-bc': '#3C9048',
                        'region-alberta': '#86264E',
                        'region-prairies': '#BD8528',
                        'region-ontario': '#BB682C',
                        'region-quebec': '#427FA4',
                        'region-atlantic': '#208A99',
                        'region-online': '#5A1F65',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html, body {
            font-family: 'Manrope', sans-serif;
            scroll-behavior: smooth;
        }
        body {
            background-color: #f8fafc; /* slate-50 */
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 80rem; /* max-w-7xl */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Custom styles for dropdown and cards */
        .dropdown-panel, .year-section, .card {
            transition: all 0.3s ease-in-out;
        }
        .card.hidden, .year-section.hidden {
            opacity: 0;
            transform: scale(0.95);
            max-height: 0;
            overflow: hidden;
            margin: 0 !important;
            padding: 0 !important;
            border: none;
            pointer-events: none;
        }
        .filter-button:hover .dropdown-arrow {
             transform: translateY(2px);
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto my-8 md:my-12">
        <header class="text-center mb-12">
            <a href="https://bioinformatics.ca" target="_blank" rel="noopener noreferrer">
                <img src="img/CBW_logo.png" alt="Canadian Bioinformatics Workshops Logo" class="mx-auto mb-6 h-40 w-auto">
            </a>
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">Canadian Bioinformatics Workshops</h1>
            <p class="text-lg text-gray-500 mt-3 max-w-2xl mx-auto">Every year, the CBW offers hands-on workshops in bioinformatics. These pages contain the materials for those workshops. You can apply for upcoming workshops here:
</p>
        </header>

        <div class="text-center mb-8 flex justify-center items-center gap-4 flex-wrap">
            <a href="https://bioinformatics.ca/workshops/workshop-application-form/" target="_blank" rel="noopener noreferrer" class="inline-block bg-brand-purple hover:bg-purple-800 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg" style="background-color: #5A1F65;">
                Apply Now
            </a>
            <a href="#about-section" class="inline-block bg-white text-brand-purple font-bold py-3 px-8 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg border-2 border-brand-purple hover:bg-purple-50">
                About
            </a>
        </div>
        
        <div class="text-center mb-12 flex justify-center items-center gap-6 border-t border-b border-gray-200 py-3">
             <a href="#current-workshops-section" class="text-gray-600 hover:text-brand-purple font-semibold transition-colors text-lg">
                Upcoming Workshops
            </a>
            <span class="text-gray-300">|</span>
             <a href="#past-workshops-section" class="text-gray-600 hover:text-brand-purple font-semibold transition-colors text-lg">
                Past Workshops
            </a>
        </div>
        <div class="mb-12 flex justify-center items-center flex-wrap gap-4 p-4 bg-slate-100/70 rounded-xl">
            <div class="relative" data-dropdown="year">
                <button data-dropdown-button class="filter-button bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2.5 px-5 border border-gray-300 rounded-lg shadow-sm flex items-center transition-all duration-200">
                    <span>Year</span>
                    <span id="year-filter-count" class="ml-2 bg-brand-purple text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    <svg class="dropdown-arrow w-4 h-4 ml-2 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div data-dropdown-panel id="year-filter-options" class="dropdown-panel hidden absolute z-10 mt-2 w-48 bg-white rounded-md shadow-2xl border border-gray-200/80 origin-top-right right-0">
                    <div class="p-2 space-y-1">
                        </div>
                </div>
            </div>

            <div class="relative" data-dropdown="region">
                <button data-dropdown-button class="filter-button bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2.5 px-5 border border-gray-300 rounded-lg shadow-sm flex items-center transition-all duration-200">
                    <span>Region</span>
                    <span id="region-filter-count" class="ml-2 bg-brand-purple text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    <svg class="dropdown-arrow w-4 h-4 ml-2 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div data-dropdown-panel id="region-filter-options" class="dropdown-panel hidden absolute z-10 mt-2 w-48 bg-white rounded-md shadow-2xl border border-gray-200/80 origin-top-right right-0">
                    <div class="p-2 space-y-1">
                        </div>
                </div>
            </div>

            <div class="relative" data-dropdown="title">
                <button data-dropdown-button class="filter-button bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2.5 px-5 border border-gray-300 rounded-lg shadow-sm flex items-center transition-all duration-200">
                    <span>Workshop</span>
                    <span id="title-filter-count" class="ml-2 bg-brand-purple text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    <svg class="dropdown-arrow w-4 h-4 ml-2 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div data-dropdown-panel id="title-filter-options" class="dropdown-panel hidden absolute z-10 mt-2 w-56 bg-white rounded-md shadow-2xl border border-gray-200/80 origin-top-right right-0 max-h-60 overflow-y-auto">
                    <div class="p-2 space-y-1">
                        </div>
                </div>
            </div>

            <div class="relative" data-dropdown="topics">
                <button data-dropdown-button class="filter-button bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2.5 px-5 border border-gray-300 rounded-lg shadow-sm flex items-center transition-all duration-200">
                    <span>Topics</span>
                    <span id="topic-filter-count" class="ml-2 bg-brand-purple text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    <svg class="dropdown-arrow w-4 h-4 ml-2 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div data-dropdown-panel id="topic-filter-options" class="dropdown-panel hidden absolute z-10 mt-2 w-56 bg-white rounded-md shadow-2xl border border-gray-200/80 origin-top-right right-0">
                    <div class="p-2 space-y-1">
                        </div>
                </div>
            </div>

            <div class="relative" data-dropdown="format">
                <button data-dropdown-button class="filter-button bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2.5 px-5 border border-gray-300 rounded-lg shadow-sm flex items-center transition-all duration-200">
                    <span>Format</span>
                    <span id="format-filter-count" class="ml-2 bg-brand-purple text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    <svg class="dropdown-arrow w-4 h-4 ml-2 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div data-dropdown-panel id="format-filter-options" class="dropdown-panel hidden absolute z-10 mt-2 w-48 bg-white rounded-md shadow-2xl border border-gray-200/80 origin-top-right right-0">
                    <div class="p-2 space-y-1">
                        </div>
                </div>
            </div>

             <div class="relative" data-dropdown="status">
                <button data-dropdown-button class="filter-button bg-white hover:bg-gray-50 text-gray-700 font-semibold py-2.5 px-5 border border-gray-300 rounded-lg shadow-sm flex items-center transition-all duration-200">
                    <span>Status</span>
                    <span id="status-filter-count" class="ml-2 bg-brand-purple text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    <svg class="dropdown-arrow w-4 h-4 ml-2 text-gray-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div data-dropdown-panel id="status-filter-options" class="dropdown-panel hidden absolute z-10 mt-2 w-48 bg-white rounded-md shadow-2xl border border-gray-200/80 origin-top-right right-0">
                    <div class="p-2 space-y-1">
                        </div>
                </div>
            </div>

            <button id="reset-filters-button" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-sm flex items-center transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 9a9 9 0 0114.12-5.12M20 15a9 9 0 01-14.12 5.12" />
                </svg>
                Reset
            </button>
        </div>

        <main id="link-container" class="space-y-16">
            </main>

        <section id="about-section" class="mt-20 pt-16 border-t border-gray-200">
             <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 tracking-tight text-center">About The Canadian Bioinformatics Workshops</h2>
             <div class="max-w-4xl mx-auto mt-8 text-lg text-gray-600 space-y-6 text-left">
                <p>The Canadian Bioinformatics Workshops (CBW) series was initiated in 1999 by the Canadian Genetic Diseases Network as a forum for graduate students and other researchers to learn about new tools and techniques in bioinformatics. The series has been a great success, with over 5,000 trainees attending workshops since its inception.</p>
                <p>Our mission is to provide accessible, high-quality, and hands-on training in bioinformatics to the Canadian research community. We cover a wide range of topics, from foundational skills in programming and data analysis to advanced topics in genomics, proteomics, and systems biology. Workshops are delivered by expert instructors from across Canada and are designed to be highly interactive, ensuring that participants gain practical skills they can immediately apply to their own research.</p>
                <p>The CBW is a key component of the bioinformatics training landscape in Canada, supported by a consortium of institutions dedicated to advancing computational biology research and education.</p>
             </div>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            // --- Fetch data and initialize the application ---
            async function initializeApp() {
                try {
                    // Fetch data from the external JSON file
                    const response = await fetch('workshops.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const linksData = await response.json();

                    // Define the canonical order of regions
                    const regionOrder = ['BC', 'Alberta', 'Prairies', 'Ontario', 'Quebec', 'Atlantic', 'Online'];
                    
                    // Define a constant for today's date, time-stripped for accurate comparisons
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // --- DOM Elements ---
                    const linkContainer = document.getElementById('link-container');
                    const yearFilterContainer = document.getElementById('year-filter-options').firstElementChild;
                    const topicFilterContainer = document.getElementById('topic-filter-options').firstElementChild;
                    const regionFilterContainer = document.getElementById('region-filter-options').firstElementChild;
                    const titleFilterContainer = document.getElementById('title-filter-options').firstElementChild;
                    const statusFilterContainer = document.getElementById('status-filter-options').firstElementChild;
                    const formatFilterContainer = document.getElementById('format-filter-options').firstElementChild;
                    const resetButton = document.getElementById('reset-filters-button');

                    // --- State ---
                    let activeYears = new Set();
                    let activeTopics = new Set();
                    let activeRegions = new Set();
                    let activeTitles = new Set();
                    let activeFormats = new Set();

                    // --- Helper Functions ---
                    
                    /**
                     * Formats a date range into a human-readable string.
                     */
                    function formatDateRange(startDateStr, endDateStr) {
                        const start = new Date(startDateStr + 'T00:00:00');
                        const end = new Date(endDateStr + 'T00:00:00');
                        const startMonth = start.toLocaleString('en-US', { month: 'long' });
                        const startDay = start.getDate();
                        const year = start.getFullYear();

                        if (!endDateStr || startDateStr === endDateStr) {
                            return `${startMonth} ${startDay}, ${year}`;
                        }
                        const endMonth = end.toLocaleString('en-US', { month: 'long' });
                        const endDay = end.getDate();
                        if (startMonth === endMonth) {
                            return `${startMonth} ${startDay}-${endDay}, ${year}`;
                        } else {
                            return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
                        }
                    }
                    
                    /**
                     * Creates and returns a complete HTML element for a workshop card.
                     */
                    function createCardElement(link) {
                        const card = document.createElement('article');
                        card.className = `card flex flex-col bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition-all duration-300 ease-in-out hover:shadow-xl`;
                        card.dataset.tags = JSON.stringify(link.tags);
                        card.dataset.regions = JSON.stringify(link.regions);
                        card.dataset.title = link.title;
                        card.dataset.startDate = link.startDate;
                        card.dataset.format = link.format;

                        const colorBar = document.createElement('div');
                        colorBar.className = 'h-1.5';
                        const sortedRegions = [...link.regions].sort((a,b) => regionOrder.indexOf(a) - regionOrder.indexOf(b));
                        const regionColors = sortedRegions
                            .map(region => tailwind.config.theme.extend.colors[`region-${region.toLowerCase()}`])
                            .filter(Boolean);
                        if (regionColors.length > 1) {
                            colorBar.style.backgroundImage = `linear-gradient(to right, ${regionColors.join(', ')})`;
                        } else if (regionColors.length === 1) {
                            colorBar.style.backgroundColor = regionColors[0];
                        } else {
                            colorBar.classList.add('bg-gray-300');
                        }
                        card.appendChild(colorBar);

                        const workshopStartDate = new Date(link.startDate + 'T00:00:00');
                        const workshopEndDate = new Date(link.endDate + 'T00:00:00');
                        
                        let statusFlagHTML = '';
                        if (workshopStartDate <= today && today <= workshopEndDate) {
                            statusFlagHTML = `<div class="absolute top-2 left-2 bg-green-500 text-white text-xs font-bold uppercase px-3 py-1 rounded-full shadow-lg">Happening Now</div>`;
                        } else if (workshopStartDate > today) {
                            statusFlagHTML = `<div class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-xs font-bold uppercase px-3 py-1 rounded-full shadow-lg">Upcoming</div>`;
                        }

                        const cardContent = document.createElement('div');
                        cardContent.className = 'flex-grow flex flex-col';
                        cardContent.innerHTML = `
                            <div class="relative">
                                <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block">
                                    <img class="w-full h-48 object-cover" src="${link.image}" alt="${link.title} workshop image" onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=800';">
                                </a>
                                ${statusFlagHTML}
                                <div class="absolute top-2 right-2 flex flex-wrap gap-2 justify-end">
                                    ${sortedRegions.map(region => {
                                        const regionColor = `bg-region-${region.toLowerCase().replace(' ', '-')}`;
                                        return `<span class="inline-block ${regionColor} text-white rounded-full px-3 py-1 text-xs font-bold shadow-sm">${region}</span>`
                                    }).join('')}
                                </div>
                            </div>
                            <div class="p-5 flex flex-col flex-grow">
                                <div class="mb-4">
                                    <h3 class="text-lg font-bold text-gray-800 mb-3">
                                        <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="hover:text-brand-purple transition-colors">${link.title}</a>
                                    </h3>
                                    <div class="space-y-2">
                                        <div class="flex items-center text-sm text-gray-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                            <span class="font-medium">${formatDateRange(link.startDate, link.endDate)}</span>
                                        </div>
                                        <div class="flex items-center text-sm text-gray-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <span class="font-medium">${link.location}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        card.appendChild(cardContent);
                        return card;
                    }

                    /**
                     * Partitions data, then generates and renders all workshop sections and cards.
                     */
                    function generatePageContent() {
                        linkContainer.innerHTML = '';

                        const currentAndUpcomingLinks = [];
                        const pastLinks = [];
                        
                        for (const link of linksData) {
                            const workshopEndDate = new Date(link.endDate + 'T00:00:00');
                            if (workshopEndDate >= today) {
                                currentAndUpcomingLinks.push(link);
                            } else {
                                pastLinks.push(link);
                            }
                        }

                        if (currentAndUpcomingLinks.length > 0) {
                            const currentSection = document.createElement('section');
                            currentSection.className = 'year-section';
                            currentSection.dataset.year = 'current';
                            currentSection.id = 'current-workshops-section'; // MODIFICATION: Added ID for anchor link
                            
                            const currentTitle = document.createElement('h2');
                            currentTitle.className = 'text-3xl font-bold mb-8 text-gray-800 pl-3 border-l-4 border-green-500';
                            currentTitle.textContent = 'Upcoming & Happening Now';
                            currentSection.appendChild(currentTitle);

                            const cardGrid = document.createElement('div');
                            cardGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
                            
                            currentAndUpcomingLinks.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                            
                            currentAndUpcomingLinks.forEach(link => {
                                cardGrid.appendChild(createCardElement(link));
                            });
                            
                            currentSection.appendChild(cardGrid);
                            linkContainer.appendChild(currentSection);
                        }

                        const pastLinksByYear = pastLinks.reduce((acc, link) => {
                            (acc[link.year] = acc[link.year] || []).push(link);
                            return acc;
                        }, {});

                        const sortedYears = Object.keys(pastLinksByYear).sort((a, b) => b - a);

                        // MODIFICATION START: Logic to assign ID to the first past section
                        let firstPastSectionAssigned = false;
                        // MODIFICATION END

                        sortedYears.forEach(year => {
                            const yearSection = document.createElement('section');
                            yearSection.className = 'year-section';
                            yearSection.dataset.year = year;
                            
                            // MODIFICATION START: Assign ID if this is the first past section
                            if (!firstPastSectionAssigned) {
                                yearSection.id = 'past-workshops-section';
                                firstPastSectionAssigned = true;
                            }
                            // MODIFICATION END
                            
                            const yearTitle = document.createElement('h2');
                            yearTitle.className = 'text-3xl font-bold mb-8 text-gray-800 pl-3 border-l-4 border-brand-purple';
                            yearTitle.textContent = `Past Workshops: ${year}`;
                            yearSection.appendChild(yearTitle);

                            const cardGrid = document.createElement('div');
                            cardGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
                            
                            pastLinksByYear[year].forEach(link => {
                                cardGrid.appendChild(createCardElement(link));
                            });

                            yearSection.appendChild(cardGrid);
                            linkContainer.appendChild(yearSection);
                        });
                    }

                    /**
                     * Creates a checkbox element for filtering.
                     */
                    function createCheckbox(value, type) {
                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-3 p-2 hover:bg-slate-100 rounded-md cursor-pointer';
                        label.innerHTML = `<input type="checkbox" data-type="${type}" value="${value}" class="h-4 w-4 rounded border-gray-300 text-brand-purple focus:ring-brand-purple/50"><span class="text-sm text-gray-700 font-medium">${value}</span>`;
                        return label;
                    }

                    /**
                     * Generates checkboxes for all filter categories.
                     */
                    function generateFilterOptions() {
                        const years = [...new Set(linksData.map(link => link.year))].sort((a, b) => b - a);
                        const topics = [...new Set(linksData.flatMap(link => link.tags))].sort();
                        const titles = [...new Set(linksData.map(link => link.title))].sort();
                        const formats = ['Online', 'In-person', 'Distributed', 'Flipped', 'Asynchronous'];

                        years.forEach(year => yearFilterContainer.appendChild(createCheckbox(year, 'year')));
                        regionOrder.forEach(region => regionFilterContainer.appendChild(createCheckbox(region, 'region')));
                        titles.forEach(title => titleFilterContainer.appendChild(createCheckbox(title, 'title')));
                        formats.forEach(format => formatFilterContainer.appendChild(createCheckbox(format, 'format')));

                        statusFilterContainer.appendChild(createCheckbox('Upcoming', 'status'));
                        statusFilterContainer.appendChild(createCheckbox('Past', 'status'));
                        statusFilterContainer.appendChild(createCheckbox('Happening Now', 'status'));


                        if (topics.length > 0) {
                            topics.forEach(topic => topicFilterContainer.appendChild(createCheckbox(topic, 'topic')));
                        } else {
                            document.querySelector('[data-dropdown="topics"]').classList.add('hidden');
                        }
                    }

                    /**
                     * Updates the badge count on filter buttons.
                     */
                    function updateFilterCounts() {
                         const yearCount = activeYears.size;
                         const topicCount = activeTopics.size;
                         const regionCount = activeRegions.size;
                         const titleCount = activeTitles.size;
                         const formatCount = activeFormats.size;
                         const statusCount = statusFilterContainer.querySelectorAll('input:checked').length;

                         document.getElementById('year-filter-count').textContent = yearCount;
                         document.getElementById('topic-filter-count').textContent = topicCount;
                         document.getElementById('region-filter-count').textContent = regionCount;
                         document.getElementById('title-filter-count').textContent = titleCount;
                         document.getElementById('format-filter-count').textContent = formatCount;
                         document.getElementById('status-filter-count').textContent = statusCount;

                         document.getElementById('year-filter-count').classList.toggle('hidden', yearCount === 0);
                         document.getElementById('topic-filter-count').classList.toggle('hidden', topicCount === 0);
                         document.getElementById('region-filter-count').classList.toggle('hidden', regionCount === 0);
                         document.getElementById('title-filter-count').classList.toggle('hidden', titleCount === 0);
                         document.getElementById('format-filter-count').classList.toggle('hidden', formatCount === 0);
                         document.getElementById('status-filter-count').classList.toggle('hidden', statusCount === 0);
                    }

                    /**
                     * Handles filter logic based on active filters.
                     */
                    function applyFilters() {
                        activeYears = new Set([...yearFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value));
                        activeTopics = new Set([...topicFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value));
                        activeRegions = new Set([...regionFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value));
                        activeTitles = new Set([...titleFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value));
                        activeFormats = new Set([...formatFilterContainer.querySelectorAll('input:checked')].map(cb => cb.value));
                        const upcomingChecked = statusFilterContainer.querySelector('input[value="Upcoming"]').checked;
                        const pastChecked = statusFilterContainer.querySelector('input[value="Past"]').checked;
                        const nowChecked = statusFilterContainer.querySelector('input[value="Happening Now"]').checked;

                        document.querySelectorAll('.year-section').forEach(section => {
                            const sectionYear = section.dataset.year;
                            let yearMatch = activeYears.size === 0 || activeYears.has(sectionYear);
                            
                            if((upcomingChecked || nowChecked) && sectionYear === 'current' && activeYears.size === 0) {
                                yearMatch = true;
                            }
                            if(pastChecked && sectionYear !== 'current' && activeYears.size === 0) {
                                yearMatch = true;
                            }

                            let visibleCardsInSection = 0;

                            section.querySelectorAll('.card').forEach(card => {
                                const cardTags = new Set(JSON.parse(card.dataset.tags));
                                const cardRegions = new Set(JSON.parse(card.dataset.regions));
                                const cardTitle = card.dataset.title;
                                const cardFormat = card.dataset.format;
                                const cardStartDate = new Date(card.dataset.startDate + 'T00:00:00');
                                const cardEndDate = new Date(linksData.find(d => d.title === cardTitle && d.startDate === card.dataset.startDate).endDate + 'T00:00:00');

                                const topicMatch = activeTopics.size === 0 || [...activeTopics].every(topic => cardTags.has(topic));
                                const regionMatch = activeRegions.size === 0 || [...activeRegions].some(region => cardRegions.has(region));
                                const titleMatch = activeTitles.size === 0 || activeTitles.has(cardTitle);
                                const formatMatch = activeFormats.size === 0 || activeFormats.has(cardFormat);
                                
                                let statusMatch = !upcomingChecked && !pastChecked && !nowChecked; 
                                if (nowChecked && cardStartDate <= today && today <= cardEndDate) statusMatch = true;
                                if (upcomingChecked && cardStartDate > today) statusMatch = true;
                                if (pastChecked && cardEndDate < today) statusMatch = true;
                                
                                if (yearMatch && topicMatch && regionMatch && titleMatch && formatMatch && statusMatch) {
                                    card.classList.remove('hidden');
                                    visibleCardsInSection++;
                                } else {
                                    card.classList.add('hidden');
                                }
                            });
                            
                            if (visibleCardsInSection > 0) {
                                section.classList.remove('hidden');
                            } else {
                                section.classList.add('hidden');
                            }
                        });
                        
                        updateFilterCounts();
                    }

                    /**
                     * Resets all filters to their default state.
                     */
                    function resetAllFilters() {
                        document.querySelectorAll('[data-dropdown-panel] input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        applyFilters();
                    }

                    /**
                     * Sets up event listeners for dropdowns and checkboxes.
                     */
                    function setupInteraction() {
                        document.querySelectorAll('[data-dropdown]').forEach(dropdown => {
                            const button = dropdown.querySelector('[data-dropdown-button]');
                            const panel = dropdown.querySelector('[data-dropdown-panel]');
                            button.addEventListener('click', (e) => {
                                e.stopPropagation();
                                document.querySelectorAll('[data-dropdown-panel]').forEach(p => { if (p !== panel) p.classList.add('hidden'); });
                                panel.classList.toggle('hidden');
                            });
                        });
                        window.addEventListener('click', () => { document.querySelectorAll('[data-dropdown-panel]').forEach(p => p.classList.add('hidden')); });
                        document.querySelectorAll('[data-dropdown-panel]').forEach(panel => { panel.addEventListener('click', e => e.stopPropagation()); });

                        yearFilterContainer.addEventListener('change', applyFilters);
                        topicFilterContainer.addEventListener('change', applyFilters);
                        regionFilterContainer.addEventListener('change', applyFilters);
                        titleFilterContainer.addEventListener('change', applyFilters);
                        statusFilterContainer.addEventListener('change', applyFilters);
                        formatFilterContainer.addEventListener('change', applyFilters);
                        resetButton.addEventListener('click', resetAllFilters);
                    }

                    // --- Initialization ---
                    generatePageContent(); // This is the new main rendering function
                    generateFilterOptions();
                    setupInteraction();
                    updateFilterCounts(); // Initial check

                } catch (error) {
                    console.error("Could not initialize the app:", error);
                    document.getElementById('link-container').innerHTML = `<p class="text-center text-red-500">Error: Could not load workshop data. Please check the console for details.</p>`;
                }
            }

            initializeApp();
        });
    </script>

</body>
</html>